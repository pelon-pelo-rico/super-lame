<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Step 10</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>body{margin:0}</style>
</head>
<body>
  <a-scene
    renderer="physicallyCorrectLights: true; colorManagement: true; toneMapping: ACESFilmicToneMapping; antialias: true"
    shadow="type: pcfsoft">

    <!-- Assets -->
    <a-assets>
      <!-- Environment -->
      <img id="pano" src="industrial_wooden_attic.jpg">
      <img id="tex1" src="rocky_terrain_02.jpg">
    </a-assets>

    <!-- Visible 360 background -->
    <a-sky id="sky" src="#pano"></a-sky>

    <!-- Lights -->
    <a-entity id="sun"
      light="type: directional; intensity: 1.2; castShadow: true"
      position="3 6 3" rotation="-45 45 0">
    </a-entity>
    <a-entity light="type: ambient; intensity: 0.35"></a-entity>

    <!-- Camera / controls -->
    <a-entity id="rig" wasd-controls position="0 1.6 0">
      <a-entity camera look-controls></a-entity>
    </a-entity>

    <!-- Transparent ground that only shows shadows -->
    <a-plane rotation="-90 0 0" position="0 0 -3" width="12" height="12"
             shadow="receive: true" shadow-receiver="opacity: 0.28">
    </a-plane>

    <!-- Objects (cast shadows) -->
    <!-- Metal sphere (strong reflections) -->
    <a-sphere position="-1.8 1 -3" radius="0.5"
              material="metalness: 1; roughness: 0.05; color: #888"
              shadow="cast: true"></a-sphere>

    <!-- Glassy cube (semi-transparent, reflective) -->
    <a-box position="0 1 -3" depth="1" height="1" width="1"
           material="color: #aaf; opacity: 0.3; transparent: true; metalness: 0.5; roughness: 0.05"
           shadow="cast: true"></a-box>

    <!-- Shiny plastic cone -->
    <a-cone position="1.8 1 -3" height="1.2" radius-bottom="0.6"
            material="color: #ff00ff; metalness: 0; roughness: 0.25"
            shadow="cast: true"></a-cone>

    <!-- Cylinder with texture -->
    <a-cylinder position="0 0.75 -1.5" radius="0.4" height="1.5"
                material="src: #tex1; roughness: 0.4; metalness: 0.05"
                shadow="cast: true"></a-cylinder>
  </a-scene>

  <script>
    // 1) Transparent shadow ground (THREE.ShadowMaterial)
    AFRAME.registerComponent('shadow-receiver', {
      schema: { opacity: { default: 0.28 } },
      init() {
        this.apply = this.apply.bind(this);
        this.el.addEventListener('object3dset', this.apply);
        this.apply();
      },
      remove() { this.el.removeEventListener('object3dset', this.apply); },
      apply() {
        const mesh = this.el.getObject3D('mesh');
        if (!mesh) return;
        mesh.traverse(o => {
          if (o.isMesh) {
            o.material = new THREE.ShadowMaterial({ opacity: this.data.opacity });
            o.material.depthWrite = false;
            o.receiveShadow = true;
          }
        });
      }
    });
    document.querySelector('a-plane').setAttribute('shadow-receiver', 'opacity: 0.28');

    // 2) Soften shadows
    const sceneEl = document.querySelector('a-scene');
    sceneEl.addEventListener('loaded', () => {
      const sun = document.getElementById('sun').getObject3D('light');
      if (sun && sun.shadow) {
        sun.shadow.mapSize.set(1024, 1024);
        sun.shadow.radius = 4;
        sun.shadow.bias = -0.0001;
        sun.shadow.normalBias = 0.02;
        const cam = sun.shadow.camera;
        cam.near = 0.5; cam.far = 50;
        cam.left = -12; cam.right = 12; cam.top = 12; cam.bottom = -12;
        cam.updateProjectionMatrix();
      }

      // 3) ***ENVIRONMENT REFLECTIONS*** from the 360 pano (PMREM)
      const renderer = sceneEl.renderer;
      if (!renderer) return;

      const pmrem = new THREE.PMREMGenerator(renderer);
      const panoSrc = document.getElementById('pano').getAttribute('src');

      new THREE.TextureLoader().load(
        panoSrc,
        (tex) => {
          // If your pano is sRGB, set color space (A-Frame/three r150+)
          if (THREE.SRGBColorSpace) tex.colorSpace = THREE.SRGBColorSpace;
          // Use as visible background:
          tex.mapping = THREE.EquirectangularReflectionMapping;
          sceneEl.object3D.background = tex;

          // Build prefiltered env map for PBR reflections:
          const envRT = pmrem.fromEquirectangular(tex);
          sceneEl.object3D.environment = envRT.texture;
        },
        undefined,
        (err) => console.warn('Failed to load pano for env map:', err)
      );
    });
  </script>
</body>
</html>    <a-box position="0 1 -3" depth="1" height="1" width="1"
           material="color: #aaf; opacity: 0.25; transparent: true; metalness: 0.5; roughness: 0.05">
    </a-box>

    <!-- Shiny plastic cone -->
    <a-cone position="1.8 1 -3" height="1.2" radius-bottom="0.6"
            material="color: #ff00ff; metalness: 0.5; roughness: 0.25">
    </a-cone>

    <!-- Cylinder with image texture -->
    <a-cylinder position="0 0.75 -1.5" radius="0.4" height="1.5"
                material="src: #tex1; roughness: 0.4; metalness: 0.1">
    </a-cylinder>
  </a-scene>

  <script>
    // Use the pano as the environment map (reflections) via PMREM
    const sceneEl = document.querySelector('a-scene');
    sceneEl.addEventListener('loaded', () => {
      const renderer = sceneEl.renderer;
      if (!renderer) return;

      const pmrem = new THREE.PMREMGenerator(renderer);
      new THREE.TextureLoader().load(
        document.getElementById('pano').getAttribute('src'),
        (tex) => {
          tex.mapping = THREE.EquirectangularReflectionMapping;
          // Prefilter for PBR (smoother, realistic reflections)
          const envMap = pmrem.fromEquirectangular(tex).texture;
          sceneEl.object3D.background = tex;     // keep pano as background
          sceneEl.object3D.environment = envMap; // reflections for PBR
        }
      );
    });
  </script>
</body>
</html>
